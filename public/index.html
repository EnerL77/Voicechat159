<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>evermind Test Chat</title>
  <style>
    :root{ color-scheme: light dark; }
    *{ box-sizing: border-box; }
    body{
      margin:0; min-height:100dvh; display:grid; place-items:center;
      font:16.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#f7f8fa; color:#111; padding:24px;
    }
    .card{
      width:min(720px, 96vw); background:#fff; color:#111;
      border:1px solid #e5e7eb; border-radius:16px; padding:clamp(16px,4vw,28px);
      box-shadow:0 8px 30px rgba(0,0,0,.08);
    }
    h1{ margin:0 0 6px; font-size:clamp(22px,6vw,32px); text-align:center; }
    p.desc{ margin:0 0 16px; text-align:center; color:#555; }
    .row{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:10px; }
    button{ appearance:none; border:none; border-radius:14px; cursor:pointer;
      padding:14px 18px; font-weight:800; letter-spacing:.2px; background:#111; color:#fff; }
    button.secondary{ background:#e7e7e7; color:#111; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .status{ text-align:center; margin-top:10px; color:#444; }
    audio{ display:block; width:100%; margin-top:10px; }
    @media (prefers-color-scheme: dark){
      body{ background:#0f1115; color:#e9eef5; }
      .card{ background:#121826; color:#e9eef5; border-color:#243; }
      p.desc{ color:#b7c0cc; }
      button.secondary{ background:#2a3244; color:#fff; }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>evermind Test Chat</h1>
    <p class="desc">Klicke auf <b>Start</b>, erlaube den Mikrofon-Zugriff und sprich normal. Der Assistent antwortet mit Stimme.</p>

    <div class="row">
      <button id="start">🎤 Start</button>
      <button id="stop" class="secondary" disabled>■ Stop</button>
    </div>
    <div class="status" id="status">Bereit</div>
    <audio id="remote" controls playsinline></audio>
  </main>

  <script>
  (function(){
    // 👉 deine ElevenLabs Agent-ID:
    const AGENT_ID = "agent_2701k4dev72vff187cxwxqd2je9p";
    // Wir sprechen NUR mit unserem Proxy (kein CORS/„Method Not Allowed“):
    const PROXY_URL = `/api/eleven/webrtc?agent_id=${encodeURIComponent(AGENT_ID)}`;

    const startBtn = document.getElementById("start");
    const stopBtn  = document.getElementById("stop");
    const statusEl = document.getElementById("status");
    const remoteEl = document.getElementById("remote");

    let pc = null;
    let micStream = null;

    const setStatus = t => statusEl.textContent = t;

    async function startCall(){
      try{
        startBtn.disabled = true;
        setStatus("Verbinden …");

        pc = new RTCPeerConnection();

        pc.ontrack = (ev) => {
          if (!remoteEl.srcObject) remoteEl.srcObject = ev.streams[0];
          remoteEl.play().catch(()=>{});
        };

        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        pc.addTrack(micStream.getTracks()[0], micStream);
        pc.addTransceiver("audio", { direction: "recvonly" });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const r = await fetch(PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/sdp" },
          body: offer.sdp
        });

        if(!r.ok) throw new Error(await r.text() || "WebRTC start failed");

        const answerSdp = await r.text();
        await pc.setRemoteDescription({ type: "answer", sdp: answerSdp });

        setStatus("Verbunden – bitte sprechen 🎙️");
        stopBtn.disabled = false;
      } catch (err){
        console.error(err);
        setStatus("Fehler: " + (err?.message || err));
        startBtn.disabled = false;
        cleanup();
        alert("Start fehlgeschlagen:\n" + (err?.message || err));
      }
    }

    function cleanup(){
      if (pc){ pc.close(); pc = null; }
      if (micStream){ micStream.getTracks().forEach(t => t.stop()); micStream = null; }
      stopBtn.disabled = true;
      startBtn.disabled = false;
      setStatus("Bereit");
    }

    startBtn.addEventListener("click", startCall);
    stopBtn.addEventListener("click", cleanup);
    window.addEventListener("beforeunload", cleanup);
  })();
  </script>
</body>
</html>
